---
title: "Aggregation Descriptives"
format:
  html:
    toc: true
    toc-expand: false
---


```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE)

```

```{r, include = F}
options(scipen = 999)
options(tigris_use_cache = TRUE)
```

```{r, include = F, message = F}
library(tidyverse)
library(arrow)
library(leaflet)
library(tigris)
library(tictoc)
library(sf)
library(DT)
library(janitor)
```

```{r, include =F}
# Locally specific part of data folder path already stored in Renviron file
data_path <- str_c(Sys.getenv("LOCAL_PATH"),
  "era-county-level-dataset-data",
  sep = "/"
)
```

```{r, include = F}
# Read aggregated data monthly
county_month_aggregated <- read_csv(
  str_c(
    Sys.getenv("LOCAL_PATH"),
    "era-county-level-dataset",
    "outputs",
    "aggregation_outputs",
    "county_month_aggregated_2025-04-02.csv",
    sep = "/"
  )
)
```

```{r, include =F}
county_month_selected_grantees <- read_csv(
  str_c(data_path,
    "1_intermediates",
    "phpdfs",
    "6_thresholding",
    "county_month_selected_grantees_2025-03-20.csv",
    sep = "/"
  )
)
```

```{r, include =F}
# Read pre aggregated data monthly
county_month_pre_agg <- read_parquet(
  str_c(data_path, "1_intermediates",
    "phpdfs",
    "7_pre_aggregation",
    "county_month_data_ready_for_aggregation_2025-04-02.parquet",
    sep = "/"
  )
)
```

```{r, include =F}
# Read in treasury allocations for grantees
treasury_allocations_era1 <- readxl::read_excel(
  str_c(Sys.getenv("LOCAL_PATH"),
    "era-county-level-dataset",
    "public_data",
    "treasury_data",
    "ERA1 & ERA2 Allocations as of 06.21.2024.xlsx",
    sep = "/"
  ),
  sheet = "ERA1"
)

treasury_allocations_era2 <- readxl::read_excel(
  str_c(Sys.getenv("LOCAL_PATH"),
    "era-county-level-dataset",
    "public_data",
    "treasury_data",
    "ERA1 & ERA2 Allocations as of 06.21.2024.xlsx",
    sep = "/"
  ),
  sheet = "ERA2"
)
```

```{r, include =F}
# join to selected grantees to get the thresholding vars
county_month_pre_agg_joined <- county_month_pre_agg %>%
  left_join(
    county_month_selected_grantees %>%
      select(-grantee_state, -grantee_name),
    by = c("grantee_id_combined")
  ) %>% 
  filter(threshold_passing_with_complete_geography)
```

```{r, include =F}
# get counties for whole country with states
states <- states(year = 2020) %>% st_drop_geometry()
counties <- counties(year = 2020) %>%
  st_drop_geometry() %>%
  left_join(states, by = "STATEFP")
```

```{r, include = F}
# Read aggregated data
county_total_aggregated <- read_csv(
  str_c(
    Sys.getenv("LOCAL_PATH"),
    "era-county-level-dataset",
    "outputs",
    "aggregation_outputs",
    "county_total_aggregated_2025-04-02.csv",
    sep = "/"
  )
)
```

```{r, include =F}
county_total_selected_grantees <- read_csv(
  str_c(data_path,
    "1_intermediates",
    "phpdfs",
    "6_thresholding",
    "county_total_selected_grantees_2025-03-21.csv",
    sep = "/"
  )
)
```

```{r, include =F}
#Read pre aggregated data total
county_total_pre_agg <- read_parquet(
  str_c(data_path, "1_intermediates",
    "phpdfs",
    "7_pre_aggregation",
    "county_total_data_ready_for_aggregation_2025-04-02.parquet",
    sep = "/"
  )
)
```

```{r, include =F}
# join to selected grantees to get the thresholding vars total
county_total_pre_agg_joined <- county_total_pre_agg %>%
  left_join(
    county_total_selected_grantees %>%
      select(-grantee_state, -grantee_name),
    by = c("grantee_id_combined")
  ) %>% 
  filter(threshold_passing_with_complete_geography)
```

## Geographic county level

### Map of counties included in final outputs

The map below shows which counties are a part of the county-total aggregation, the county-month aggregation, or both.

```{r, include = F, message = F}
# combine data and prep
counties_total <- county_total_aggregated %>% 
  distinct(county_geoid_coalesced) %>% 
  mutate(source = "Included only in County-Total Datasets")

counties_monthly <- county_month_aggregated %>% distinct(county_geoid_coalesced) %>% 
  mutate(source = "Included in County-Month and County-Total Datasets")

full_data <- full_join(counties_total, counties_monthly, by = "county_geoid_coalesced") %>% 
  mutate(source = coalesce(source.y, source.x))

```

```{r, include = F, message = F}
counties <- counties(cb = TRUE, year = 2020)

map_data <- left_join(
  counties,
  full_data,
  by = join_by("GEOID" == "county_geoid_coalesced")
) %>%
  mutate(source = ifelse(is.na(source), "No data", source)) %>% 
  st_transform(map_data, crs = 4326)

pal <- colorFactor(palette = c("#b69ee2", "#7ebcef", "lightgray"), domain = map_data$source)

labels <- sprintf(
  "<strong>%s</strong><br/> GEOID %s",
  map_data$NAMELSAD,
  map_data$GEOID
) %>%
  map(htmltools::HTML)


map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = map_data,
    fillColor = ~ pal(source),
    color = "black",
    fillOpacity = 0.7,
    weight = 0.2,
    smoothFactor = 0.2,
    label = labels
  ) %>%
  addLegend(
    pal = pal,
    values = map_data$source,
    position = "bottomleft",
    title = paste0("Counties Included in County-Month Dataset"),
    labFormat = labelFormat(suffix = "")
  ) %>%
  leaflet::setView(lng = -100, lat = 54.5, zoom = 3)
```

```{r, echo = F, message = F}
map
```

### Number and % of counties included in the final output, by state

The table below presents county coverage by state. The tabs above the table can be toggled to view data for each dataset.

::: panel-tabset

## County-Month Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
county_month_pre_agg_joined %>%
  distinct(county_geoid_coalesced, .keep_all = TRUE) %>%
  left_join(counties, by = join_by("geocode_std_st" == "STUSPS")) %>%
  distinct() %>%
  group_by(grantee_state) %>%
  mutate(total_counties = n_distinct(COUNTYFP)) %>%
  summarize(
    total = n_distinct(county_geoid_coalesced),
    pct_total_counties_covered = (total / total_counties)
  ) %>%
mutate(pct_total_counties_covered = round(pct_total_counties_covered, 3)) %>% 
  distinct() %>%
  datatable() %>% 
  formatPercentage("pct_total_counties_covered", digits = 3)
```

## County-Total Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
county_total_pre_agg_joined %>%
  distinct(county_geoid_coalesced, .keep_all = TRUE) %>%
  left_join(counties, by = join_by("geocode_std_st" == "STUSPS")) %>%
  distinct() %>%
  group_by(grantee_state) %>%
  mutate(total_counties = n_distinct(COUNTYFP)) %>%
  summarize(
    total = n_distinct(county_geoid_coalesced),
    pct_total_counties_covered = (total / total_counties) 
  ) %>%
mutate(pct_total_counties_covered = round(pct_total_counties_covered, 3)) %>% 
  distinct() %>%
  datatable() %>% 
  formatPercentage("pct_total_counties_covered", digits = 3)
```

:::

### Counties with high share of missing addresses

Payment records may be locatable to a county even if its street address is missing (for example, if an ERA grantee's jurisdiction is entirely within a single county). 

In deriving the number of unique assisted addresses for the aggregation, we treat records with missing addresses as unique from every other address. However, this assumption is liberal because multiple payments to a single address cannot be distinguished from single payments to multiple addresses if the address is missing.

Therefore, if a county includes a large proportion of records with missing addresses, the number of unique assisted addresses may be inflated. The table below presents these data. For example, nearly 100% of records located to Washington, D.C. are missing street address.

::: panel-tabset

## County-Month Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
county_month_pre_agg_joined %>% 
  mutate(missing_address = street_address == as.character(row_number())) %>%
  group_by(county_geoid_coalesced, missing_address) %>% 
  summarize(n = n()) %>% 
  mutate(percent = round((n / sum(n)), 3)) %>% 
  filter(missing_address == TRUE) %>% 
  select(-missing_address) %>% 
  rename(n_missing_addresses = n) %>% 
  arrange(desc(percent)) %>% 
  mutate(percent = round(percent, 3)) %>% 
  left_join(counties %>% st_drop_geometry() %>% select(GEOID, NAMELSAD, STUSPS), 
    by = join_by("county_geoid_coalesced" == "GEOID")) %>% 
rename(county_name = NAMELSAD, state = STUSPS) %>%
relocate(county_geoid_coalesced, county_name, state) %>% 
  datatable() %>% 
  formatRound(c("n_missing_addresses"), digits = 0) %>% 
  formatPercentage("percent", digits = 3)

```

## County-Total Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
county_total_pre_agg_joined %>% 
  mutate(missing_address = street_address == as.character(row_number())) %>%
  group_by(county_geoid_coalesced, missing_address) %>% 
  summarize(n = n()) %>% 
  mutate(percent = round((n / sum(n)), 3)) %>% 
  filter(missing_address == TRUE) %>% 
  select(-missing_address) %>% 
  rename(n_missing_addresses = n) %>% left_join(counties %>% st_drop_geometry() %>% select(GEOID, NAMELSAD, STUSPS), 
    by = join_by("county_geoid_coalesced" == "GEOID")) %>% 
rename(county_name = NAMELSAD, state = STUSPS) %>%
relocate(county_geoid_coalesced, county_name, state) %>% 
  arrange(desc(percent)) %>% 
  mutate(percent = round(percent, 3)) %>% 
  datatable() %>% 
  formatRound(c("n_missing_addresses"), digits = 0) %>% 
  formatPercentage("percent", digits = 3)

```

:::

## Grantee level

The tables below present information relating to data coverage and quality. These data are presented at the *grantee* level, rather than at the geographic county level, because data thresholding decisions were made at the grantee level.

### Number of grantees included, by type

::: panel-tabset

## County-Month Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# total number of grantees, by grantee_geographic_level monthly
county_month_pre_agg_joined %>%
  distinct(grantee_name, .keep_all = T) %>%
  count(grantee_geographic_level) %>%
  rename(number_of_grantees = n) %>% 
left_join(
county_month_selected_grantees %>%
    group_by(geographic_level) %>%
    mutate(total = n()) %>%
    filter(threshold_passing_with_complete_geography) %>% 
    group_by(threshold_passing_with_complete_geography, geographic_level) %>%
    summarise(
        passing_total = n(),
        total = first(total),
        pct_of_total_passing = passing_total/total) %>% 
select(-passing_total, -total, -threshold_passing_with_complete_geography), 
by = join_by("grantee_geographic_level" == "geographic_level")) %>% 
select(-threshold_passing_with_complete_geography) %>% 
  datatable() %>% 
  formatPercentage("pct_of_total_passing", 
                   digits = 3)
```

## County-Total Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# total number of grantees, by grantee_geographic_level total
county_total_pre_agg_joined %>%
  distinct(grantee_name, .keep_all = T) %>%
  count(grantee_geographic_level) %>%
  rename(number_of_grantees = n) %>% 
left_join(
county_total_selected_grantees %>%
    group_by(geographic_level) %>%
    mutate(total = n()) %>%
    filter(threshold_passing_with_complete_geography) %>% 
    group_by(threshold_passing_with_complete_geography, geographic_level) %>%
    summarise(
        passing_total = n(),
        total = first(total),
        pct_of_total_passing = passing_total/total) %>% 
select(-passing_total, -total, -threshold_passing_with_complete_geography), 
by = join_by("grantee_geographic_level" == "geographic_level")) %>% 
select(-threshold_passing_with_complete_geography) %>% 
  datatable() %>% 
  formatPercentage("pct_of_total_passing", 
                   digits = 3)
```

:::

### Number of grantees included, by state and type

::: panel-tabset

## County-Month Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# number of grantees in each state, by grantee_geographic_level monthly
county_month_pre_agg_joined %>%
  distinct(grantee_name, .keep_all = T) %>%
  count(grantee_state, grantee_geographic_level) %>%
  rename(number_of_grantees = n) %>% 
  mutate(total = sum(number_of_grantees),
        pct_of_total_grantees = round(number_of_grantees/total, 3)) %>% 
select(-total) %>% 
  datatable() %>% 
  formatPercentage("pct_of_total_grantees", 
                   digits = 3)
```

## County-Total Dataset

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# number of grantees in each state, by grantee_geographic_level total
county_total_pre_agg_joined %>%
  distinct(grantee_name, .keep_all = T) %>%
  count(grantee_state, grantee_geographic_level) %>%
  rename(number_of_grantees = n) %>% 
  mutate(total = sum(number_of_grantees),
        pct_of_total_grantees = round(number_of_grantees/total, 3)) %>% 
select(-total) %>% 
  datatable() %>% 
  formatPercentage("pct_of_total_grantees", 
                   digits = 3)
```

:::

### Grantees included with less than 90% variable quality

This table shows grantees included in the aggregations where less than 90% of their records (for either ERA1 or ERA2) met all of the following criteria:

- Record within the geographic jurisdiction of the grantee
- Record locatable to a specific county
- Positive payment amount recorded, below 99.9th percentile value of all records
- (For county-month dataset only) Date of payment recorded, neither too early nor too late for the program

Please see [the Methods page](methods.md#step-5-variable-checks) for more details on the thresholding process. 

::: panel-tabset

## County-Month Dataset

```{r, echo = F, message = F, warning = F}
county_month_selected_grantees %>% 
  filter(threshold_passing_with_complete_geography == TRUE) %>% 
  filter(ok_percent_era1 < 0.9 | ok_percent_era2 < 0.9) %>% 
  select(grantee_state, grantee_name, 
         ok_percent_era1, ok_percent_era2) %>% 
  arrange(ok_percent_era2, ok_percent_era1) %>% 
  datatable() %>% 
  formatPercentage(c("ok_percent_era1", "ok_percent_era2"), 
                   digits = 3)
```

## County-Total Dataset

```{r, echo = F, message = F, warning = F}
county_total_selected_grantees %>% 
  filter(threshold_passing_with_complete_geography == TRUE) %>% 
  filter(ok_percent_era1 < 0.9 | ok_percent_era2 < 0.9) %>% 
  select(grantee_state, grantee_name, 
         ok_percent_era1, ok_percent_era2) %>% 
  arrange(ok_percent_era2, ok_percent_era1) %>% 
  datatable() %>% 
  formatPercentage(c("ok_percent_era1", "ok_percent_era2"), 
                   digits = 3)
```

:::

### Grantees included with low spending amounts

This table shows grantees included in the aggregations where the grantee's summed positive payments in the ERA1 file was less than 80% of their final allocation for ERA1, or where their summed positive payments in the ERA2 file was less than 50% of their final allocation for ERA2.

These grantees may not have fully reported their assistance spending, especially for ERA2.

::: panel-tabset

## County-Month Dataset

```{r, echo = F, message = F, warning = F}
county_month_selected_grantees %>% 
  filter(threshold_passing_with_complete_geography == TRUE) %>% 
  filter(percent_of_allocation_spent_era1 < 0.8 | percent_of_allocation_spent_era2 < 0.5) %>% 
  select(grantee_state, grantee_name, 
         percent_of_allocation_spent_era1, percent_of_allocation_spent_era2) %>% 
  arrange(percent_of_allocation_spent_era2, percent_of_allocation_spent_era1) %>% 
  datatable() %>% 
  formatPercentage(c("percent_of_allocation_spent_era1", "percent_of_allocation_spent_era2"), 
                   digits = 3)
```

## County-Total Dataset

```{r, echo = F, message = F, warning = F}
county_total_selected_grantees %>% 
  filter(threshold_passing_with_complete_geography == TRUE) %>% 
  filter(percent_of_allocation_spent_era1 < 0.8 | percent_of_allocation_spent_era2 < 0.5) %>% 
  select(grantee_state, grantee_name, 
         percent_of_allocation_spent_era1, percent_of_allocation_spent_era2) %>% 
  arrange(percent_of_allocation_spent_era2, percent_of_allocation_spent_era1) %>% 
  datatable() %>% 
  formatPercentage(c("percent_of_allocation_spent_era1", "percent_of_allocation_spent_era2"), 
                   digits = 3)
```

:::


